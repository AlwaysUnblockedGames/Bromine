---
import Popup from "@/Popup.astro"
---

<Popup
  title="History"
  label="History"
  triggerIcon="ph:clock-counter-clockwise-bold"
  triggerId="omnibar-history-btn"
  popupId="history-popup"
  contentId="history-popup-content"
  closeBtnId="history-close-btn"
>
  <ul class="space-y-2" id="history"></ul>
</Popup>

<script>
  import { getProxied } from "@/utils/lethal.ts";

  function renderList() {
    const history = JSON.parse(localStorage.getItem("history") || "[]");
    const list = document.getElementById("history");
    if (!list) return;
    list.innerHTML = "";

    if (history.length === 0) {
      list.innerHTML = `<p class="text-center text-gold/70 py-4">No browsing history yet</p>`;
      return;
    }

    history.forEach((item) => {
      const li = document.createElement("li");
      li.className = "py-2 px-3 rounded-md hover:bg-gold/10 transition-colors cursor-pointer";
      li.innerHTML = `
        <div class="flex items-center">
          <span class="w-4 h-4 mr-2 text-gold">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </span>
          <div class="flex flex-col">
            <span title="${item.title}" class="text-gold font-medium text-sm">${item.title}</span>
            <span title="${item.url}" class="text-gold/70 text-xs truncate">${item.url}</span>
          </div>
        </div>
      `;
      li.addEventListener("click", async () => {
        currentFrame.src = await getProxied(item.url);
      });
      list.appendChild(li);
    });
  }

  window.addEventListener("storage", (event) => {
    if (event.key === "history") {
      renderList();
    }
  });

  window.addEventListener("history-changed", renderList);

  document.addEventListener("popup-opened", ({ detail }) => {
    if (detail?.popupId === "history-popup") {
      renderList();
    }
  });

  renderList();
</script>
